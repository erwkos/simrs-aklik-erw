<!-- readmisi.html -->

{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load my_tags %}
{% load custom_filters %}
{% load query_transform %}
{% load static %}
{% load humanize %}

{% block scriptheader %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="/static/django_select2/django_select2.css" rel="stylesheet" />
<script src="/static/django_select2/django_select2.js"></script>

{% endblock %}

{% block content %}
<style>
  .table-header {
    background-color: #d9eaf7;
    text-align: center;
    font-weight: bold;
    vertical-align: middle;
  }
  .table th, .table td {
    vertical-align: middle;
    text-align: center;
  }
  .card {
    margin-top: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    overflow-x: hidden; /* Mencegah overflow horizontal */
  }

  .detail-container {
    margin-top: 20px;
    padding: 20px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    display: none; /* Sembunyikan container detail awalnya */
  }

  .active-row {
    background-color: #cccccc; /* Warna biru muda sebagai contoh */
  }

  /* Tombol oval untuk link nama */
  .btn-oval {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    background-color: #007bff; /* Warna biru */
    color: white;
    text-decoration: none;
    font-weight: bold;
    transition: background-color 0.3s;
    cursor: pointer;
  }

  .btn-oval:hover {
    background-color: #0056b3; /* Warna biru gelap saat hover */
    text-decoration: none;
  }

  /* Styling tambahan untuk pagination */
  .pagination .page-link {
    color: #007bff;
  }

  .pagination .page-item.active .page-link {
    background-color: white;
    border-color: #007bff;
  }

  .pagination .page-item.disabled .page-link {
      color: #6c757d;
      pointer-events: none;
      background-color: #fff;
      border-color: #dee2e6;
  }

  input[type="checkbox"].status-checkbox {
      transform: scale(1.8); /* Sesuaikan nilai skala sesuai kebutuhan */
      margin: 5px; /* Opsional: tambahkan margin untuk ruang ekstra */
  }
</style>

<div class="col-xl-12 col-md-12 mb-4 mt-4">
  <div class="card">
      <div class="card-header">
          <div class="card-title">
                <h3>Fitur Sikat (verifika<span style="color: red"><b>SI</b></span> <span style="color: red"><b>K</b></span>laim cep<span style="color: red"><b>AT</b></span>) Readmisi</h3>
          </div>
      </div>
    <div class="card-body">
      <form class="row row-cols-md-auto g-3 align-items-center" method="GET">
        <div class="col-12">
          <!-- Tambahkan input filter jika diperlukan -->
        </div>
        {{ myFilter.form | crispy }}
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
    <div class="card-body">
      <!-- Tabel Data Utama -->
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>NO REG</th>
              <th>NAMA RS</th>
              <th>NOKA</th>
              <th>NAMA</th>
              <th>JUMLAH KUNJUNGAN</th>
              <th>JUMLAH BIAYA</th>
            </tr>
          </thead>
          <tbody>
            {% for data in data_klaim %}
            <tr>
              <td>{{ data.nomor_register_klaim }}</td>
              <td>{{ data.nama_rs }}</td>
              <td>{{ data.NOKARTU }}</td>
              <td>
                <a href="#" class="no-reg-link btn-oval" data-nokartu="{{ data.NOKARTU }}" data-nmpeserta="{{ data.NMPESERTA }}">
                  {{ data.NMPESERTA }}
                </a>
              </td>
              <td>{{ data.jumlah_kunjungan }}</td>
              <td>{{ data.jumlah_biaya|rupiah }}</td> <!-- Gunakan filter rupiah -->
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination untuk tabel utama -->
      <div class="pagination justify-content-center">
          <ul class="pagination">
              {% if data_klaim.has_previous %}
                  <li class="page-item">
                      <a class="page-link" href="?{% query_transform request page=1 %}">&laquo; First</a>
                  </li>
                  <li class="page-item">
                      <a class="page-link" href="?{% query_transform request page=data_klaim.previous_page_number %}">Previous</a>
                  </li>
              {% else %}
                  <li class="page-item disabled">
                      <span class="page-link">&laquo; First</span>
                  </li>
                  <li class="page-item disabled">
                      <span class="page-link">Previous</span>
                  </li>
              {% endif %}

              <li class="page-item active">
                  <span class="page-link">
                      Page {{ data_klaim.number }} of {{ data_klaim.paginator.num_pages }}.
                  </span>
              </li>

              {% if data_klaim.has_next %}
                  <li class="page-item">
                      <a class="page-link" href="?{% query_transform request page=data_klaim.next_page_number %}">Next</a>
                  </li>
                  <li class="page-item">
                      <a class="page-link" href="?{% query_transform request page=data_klaim.paginator.num_pages %}">Last &raquo;</a>
                  </li>
              {% else %}
                  <li class="page-item disabled">
                      <span class="page-link">Next</span>
                  </li>
                  <li class="page-item disabled">
                      <span class="page-link">Last &raquo;</span>
                  </li>
              {% endif %}
          </ul>
      </div>
    </div>
  </div>
</div>

<!-- Container untuk detail akan ditambahkan secara dinamis -->

<script>
  // Data detail No Reg diambil dari context
  const dataDetail = {{ data_detail_json|safe }};

  let lastDetailRow = null; // Menyimpan elemen baris detail terakhir yang ditambahkan

  // Fungsi untuk mengirim status ke server
  function kirimStatus(nokartu, nmpeserta, no_sep, status) {
    fetch(`{% url 'verifikator:simpan_status_readmisi' %}`, {  // Perbarui URL di sini
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'  // Gunakan CSRF token
      },
      body: JSON.stringify({
        nokartu: nokartu,
        nmpeserta: nmpeserta,
        no_sep: no_sep,
        status: status
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        console.log(`Status untuk No SEP ${no_sep} berhasil disimpan.`);
      } else if (data.error) {
        alert(`Error: ${data.error}`);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Terjadi kesalahan saat menyimpan data.`);
    });
  }

  // Event listener untuk link Nama
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('no-reg-link')) {
      e.preventDefault();

      const nokartu = e.target.getAttribute('data-nokartu');
      const nmpeserta = e.target.getAttribute('data-nmpeserta');
      const regNumber = `${nokartu} ${nmpeserta}`; // Separator space

      const parentRow = e.target.closest('tr'); // Baris utama yang diklik

      // Jika detail sudah terbuka dan baris yang sama diklik, tutup detail dan hapus warna aktif
      if (lastDetailRow && lastDetailRow.previousElementSibling === parentRow) {
        lastDetailRow.remove();
        lastDetailRow = null; // Reset baris detail
        parentRow.classList.remove('active-row'); // Hapus kelas aktif
        return;
      }

      // Hapus baris detail sebelumnya jika ada, dan hapus kelas aktif dari row sebelumnya
      if (lastDetailRow) {
        lastDetailRow.previousElementSibling.classList.remove('active-row'); // Hapus kelas aktif dari row sebelumnya
        lastDetailRow.remove();
      }

      // Tambahkan kelas aktif ke row yang diklik
      parentRow.classList.add('active-row');

      // Buat baris baru untuk menampilkan detail
      lastDetailRow = document.createElement('tr');
      lastDetailRow.innerHTML = `
        <td colspan="6">
          ${generateDetailTable(regNumber)}
        </td>
      `;

      // Sisipkan baris detail di bawah baris yang diklik
      parentRow.after(lastDetailRow);

      // Inisialisasi pagination setelah memasukkan tabel detail
      initializePagination(regNumber);
    }
  });

  // Event listener untuk mencatat perubahan pada checkbox
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('status-checkbox')) {
      const regNumber = e.target.getAttribute('data-reg'); // 'nokartu nmpeserta' with space
      const row = e.target.getAttribute('data-row');
      const status = e.target.getAttribute('data-status');
      const no_sep = e.target.closest('tr').querySelector('.sep-link').getAttribute('data-sep');

      // Split regNumber into nokartu dan nmpeserta
      const [nokartu, ...nmpesertaArr] = regNumber.split(' '); // Assuming space as separator
      const nmpeserta = nmpesertaArr.join(' '); // Join in case nmpeserta has spaces

      const rowIndex = row; // Sesuaikan sesuai kebutuhan

      // Jika checkbox dicentang, simpan status
      if (e.target.checked) {
        // Uncheck checkbox lain di baris yang sama
        const checkboxes = document.querySelectorAll(`input[name="status-${regNumber}-${row}"]`);
        checkboxes.forEach(checkbox => {
          if (checkbox !== e.target) {
            checkbox.checked = false;
          }
        });

        // Kirim status ke server
        kirimStatus(nokartu, nmpeserta, no_sep, status);
      } else {
        // Jika checkbox di-uncheck, kirim status kosong atau hapus status
        kirimStatus(nokartu, nmpeserta, no_sep, null);
      }
    }
  });

  // Fungsi untuk menghasilkan tabel detail tanpa tombol Simpan dan Submit
  function generateDetailTable(regNumber) {
    const detailData = dataDetail[regNumber];
    if (!detailData || detailData.length === 0) return '<p>Tidak ada data detail tersedia.</p>';

    let tableHtml = `
      <div class="table-responsive">
        <table class="table table-bordered mt-2">
          <thead>
            <tr>
              <th>RS</th>
              <th>No SEP</th>
              <th>IN</th>
              <th>OUT</th>
              <th>Poli</th>
              <th>CBG</th>
              <th>Tarif</th>
              <th>Layak</th>
              <th>Pending</th>
              <th>Tidak Layak</th>
              <th>Dispute</th>
            </tr>
          </thead>
          <tbody id="tbody-detail-${regNumber}">
    `;

    detailData.forEach((data, rowIndex) => {
      tableHtml += `
        <tr>
          <td>${data.rs}</td>
          <td><a href="/verifikator/detail-data-klaim-verifkhusus/${data.no_sep}/" class="sep-link" data-sep="${data.no_sep}" target="_blank">${data.no_sep}</a></td>
          <td>${data.in}</td>
          <td>${data.out}</td>
          <td>${data.poli}</td>
          <td>${data.cbg}</td>
          <td>${Number(data.tarif).toLocaleString('id-ID')}</td> <!-- Format tarif -->
          ${data.status_options.map((statusOption) => {
            // Tentukan apakah statusOption adalah current_status
            const checkedAttribute = (data.current_status === statusOption) ? 'checked' : '';
            return `
              <td>
                <input type="checkbox" class="status-checkbox"
                  name="status-${regNumber}-${rowIndex}"
                  data-reg="${regNumber}"
                  data-row="${rowIndex}"
                  data-status="${statusOption}"
                  ${checkedAttribute}>
                ${statusOption}
              </td>`;
          }).join('')}
        </tr>
      `;
    });

    tableHtml += `
          </tbody>
        </table>
      </div>
      <div class="pagination-detail" id="pagination-detail-${regNumber}">
        <!-- Pagination buttons akan dihasilkan di sini -->
      </div>
    `;

    return tableHtml;
  }

  // Fungsi untuk menghasilkan tombol pagination dan mengatur tampilan halaman
  function initializePagination(regNumber) {
    const itemsPerPage = 20;
    const tbody = document.getElementById(`tbody-detail-${regNumber}`);
    const paginationDiv = document.getElementById(`pagination-detail-${regNumber}`);
    const rows = tbody.querySelectorAll('tr');
    const totalItems = rows.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    let currentPage = 1;

    function showPage(page) {
      currentPage = page;
      rows.forEach((row, index) => {
        if (index >= (page - 1) * itemsPerPage && index < page * itemsPerPage) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
      updatePaginationControls();
    }

    function updatePaginationControls() {
      paginationDiv.innerHTML = '';

      // Tombol Previous
      const prevButton = document.createElement('button');
      prevButton.innerHTML = 'Previous';
      prevButton.disabled = currentPage === 1;
      if (currentPage === 1) {
        prevButton.classList.add('disabled');
      }
      prevButton.onclick = () => showPage(currentPage - 1);
      paginationDiv.appendChild(prevButton);

      // Tombol halaman
      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.innerHTML = i;
        if (i === currentPage) {
          pageButton.classList.add('active');
        }
        pageButton.onclick = () => showPage(i);
        paginationDiv.appendChild(pageButton);
      }

      // Tombol Next
      const nextButton = document.createElement('button');
      nextButton.innerHTML = 'Next';
      nextButton.disabled = currentPage === totalPages;
      if (currentPage === totalPages) {
        nextButton.classList.add('disabled');
      }
      nextButton.onclick = () => showPage(currentPage + 1);
      paginationDiv.appendChild(nextButton);
    }

    // Inisialisasi halaman pertama
    showPage(1);
  }
</script>

{% endblock %}
